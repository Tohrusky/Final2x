<script lang="ts" setup>
//
// .........................................................................................
// .........................................................................................
// ..................................,]]/@@@@@@@@]]]]`......................................
// ..............................,@@@@@@@@@@@@@@@@@@@@@@@@@\`...............................
// .................... ......,/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\.............................
// .........................,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`..........................
// ......................./@@@@@@@@O@@@@@@OO@OOoO@@@@@@@@@@@@@@@@@@`........................
// ...................../O@@@@@@OO@OOOOoOOOOOO@OOOOO@@OO@@@@@@@@@@@@@`.]`...................
// ...................,//@@@@@oOO@OOO\ooooooOOO@OOooOOO@@@@@@@@@OOOOO@@@O\..................
// ................../\@@@@@ooOO@OOoooooooo/oooOO@OoooO@@@@/O@@@OOOOoO@OOOO\................
// ................./=O@@@`ooooOOo/O\\oooooo\oooo\@OoooooO@@`\/@OOO\`*O\^=OO^...............
// ................@=@@@@.\ooO/O/o=\///ooo^=,^[,`\\/O\\oooO@/@@@OOOO\`\*./o@`...............
// ...............=^@@O@.^ooo\O\\*o=**\*`=***=^,/]=/OOoooooO^`\[O@@@O\\...,oOO].............
// ...............@=@O@.,=oo/O^/,*`=*****=***^\/^,`,`O^oooooO/,o\,@OOOo]`.,OOO^.............
// ...............@@@@..*o/\oO,*.,^o******^**=*@/^*,*^O^ooooooO@]=@OOOO\]OOoOO@^............
// ...............@@@...=o,.=^.**=^o***********=\/\****O,ooooooO^=@@OOOOO@O@OO@^............
// ...............@@^...,.*.=^***=^=***********=^,\\***=\,oooooO\=@@@@@@@@@@@@@^............
// ...............\@......**O^***=^=^*....*..*^=^..\O/**\``o=oooO@@@\@@@O@@@@@@^............
// ...............=^......^*\^***=^=^.....*..,^*.....\\*=^=`\`\ooO@\/@@@@O@@@@@@^...........
// .............../.....,***=^..*O^.O.....,..=^=...,]]]@]O*\*\*=*OO@@@@@@@@@@/..............
// .............../..^..o***=\.,\^=.^,....=..^.,.=/\@@@@@@@@`*\\,=OO@@@@@@@@@...............
// ..............=^,,^..o***=O.,O..^=``..,^.^......=@@`=@^@.O*`=O\O@@@@@@@@@................
// ..............=^==O..=`***O^O]@@@@@\.............[,`.O,O.=\**,oO@@@@@@@@@@...............
// ..............=.^O=*.=^**.OO@/=@@/\@`..................@^*O\**,^@@@@@@@@@@\..............
// ............../.\^=^`=\***=@@`.\Oo/[...................OO.=@\,,,@@@@@@@@@`...............
// ..............O.=^.^\*O***,@\,^........................^O^*\@O,,,OO@@@@@@^...............
// ..............O.O..O.OO^**.\O@........................=^=O`*OOO`\`O@@@@@@@^..............
// ..............O.O..\..@O`***O@@`........,]`...........=**OO`,O\O@\\\@@@@O@@`.............
// ..............=.O..=.`,@O***=@O@\........[OOOOO`.`..../^*=O@`,\`OOO@@@@@\@@O.............
// ..............,^O..=.O.O@\***@@@@@\..../OOO@O\oO/\O,/@^o**o@O\*O*\OOO@@@,O\`\............
// ...............\=..=.o^=OO@``,@@=OOO@OOOOOO\``.o./\O@@o=.*=O/OO\,\,O@@@@.\=@`............
// ................O^.=`/O*OO\O@],@=OOOOOOOO^@oo,..*[[\@@O=^**O^^\O@O/[@@@@.=/..............
// .................\`=^=O\=^OOO@O@=OOOOOOO@@@OooOO]],=O@O^^**O@=^/OOO@@@@@.................
// ..................,O.OOOOO\=@@@^@@@@@@@@@@@@OOOOO^/@O@O^o`^=@O=//O\=O@@@.................
// ................../.=^O@O`=O/@@\@@@@@@@@@@@@@\/@OoO@@@OO=^o=@@\\/\\@/\/@^................
// ................,/,^=oO//,/^...\O@@[.....=`.,`\@@OO@@^@@=o==@@@@\//O@@O@=`......... . ...
// ..............././\.o/o\@\/..[=`=^....[[@\]^...`@@@^\@=@=o\=@O@@\Oooo@@@o=^........... ..
// ............./`/`/.=o//^/[....`./......,@@@@^].`.,[\]@^=^ooO@@@@/@Oooo@`\o/\.............
// .........../\/../,,OO/@O]],.,/[=.......,@@@@@\....../@@/O=oo@@@@`,@@Oo\@.,O\O............
// \`......]O/`..,/,`o@@/`..`....=`......,\,@@@O@@`...=@@@@@O/Oo\/*=/@@@OoO^..\\\`..........
// OOOOO@@/`....,^=^o/OO...../@@/`....,]/@@O@@@@@@@\.=@@@@O@@/oOOoOO/,@@@@OO^..=O/^.........
// OO/`......../\@//oOO....@@@@@.....,@@@@@@@@@@@@@@@@@@@@@@@@\\/[O^,\@@O@@O@...O\/^........
// ...........O/@@=OO@..../@[.[\`..==@@@@@@@@@@@@@@@@@@@@@@@@@\\O//./O[O\OO@^`..=O\O@.......
// .........,@@@@\OO@@@@@@@`.....,\`=@@@@@@@@O.]/@@@@@@@@@O/=@@\o\[^OoO\O@OO@@`.=@@@@@......
// ........=@@@@OOO@@@@@@@=.........,\@@@@@@@@OO[\/[\OO`=O/OO@@@@OO/^.,^\@@@@@@.=@@@@@@`....
//
// é»‘å¡”ä¿ä½‘ï¼Œæ°¸æ— BUG
// Herta bless, no bug forever
// å´©åï¼šæ˜Ÿç©¹é“é“ï¼Œå¯åŠ¨ï¼ https://sr.mihoyo.com/ ç‚¹å‡»ä¸‹è½½
// Honkai: Star Rail, START! https://sr.mihoyo.com/ Click to download
// ðŸ”¥ ðŸ—¡ ðŸ˜  æžªå°–å·²ç»ç‚¹ç‡ƒðŸ”¥ ðŸ”¥ ðŸ’¥ ç‚Žæžªâ€”â€” ðŸ¤ºðŸ”¥ âž¡ï¸ âž¡ï¸ âž¡ï¸ ðŸ’¥ å†²é”‹â€”â€” ðŸ¤ºðŸ”¥ ðŸ”ª â†˜ï¸ ðŸŒ‹
// ðŸ¤ºè®©ä½ å°å°ðŸ‘— ðŸ‘‡ â„ï¸ æœ¬å§‘å¨˜çš„åŽ‰å®³ðŸ˜¬ðŸ‘Œ ðŸ¹ â„ï¸ å˜¿â€”â€” â™ â™ â™ ðŸŽ† â„ï¸ ðŸ° â„ï¸ ðŸ°â„ï¸ ðŸ°â„ï¸ ðŸ° â„ï¸ ðŸ°
// æˆ‘ä»¬å·²ç»è¸å…¥é£Žé›ªðŸ’‚ðŸ»â€â™€ï¸ðŸ’‚ðŸ»â€â™€ï¸ðŸ’‚ðŸ»â€â™€ï¸ðŸ’‚ðŸ»â€â™€ï¸ðŸ’‚ðŸ»â€â™€ï¸ðŸ’‚ðŸ»â€â™€ï¸ðŸ’‚ðŸ»â€â™€ï¸ðŸ’‚ðŸ»â€â™€ï¸â„ï¸â„ï¸â„ï¸â„ï¸â„ï¸â„ï¸â„ï¸â„ï¸ä¸ºäº†å®ˆæŠ¤å’Œæå«ï¼Œå‡»æºƒä»–ä»¬ï¼ðŸ—¡ï¸ðŸ—¡ï¸âš”ï¸
// è®©å¼€ï¼ðŸ˜¤ðŸ˜¤ðŸ˜¤æ¼†é»‘çš„è™Žå…‹å¤§äººé©¾åˆ°ðŸ’ƒðŸ’ƒðŸ’ƒï¼ï¼ï¼ðŸ˜¡ðŸ˜¡ðŸ˜¡å˜Ÿå˜Ÿå˜Ÿå˜ŸðŸ‘©â€ðŸ¦½ðŸ‘©â€ðŸ¦½ðŸ‘©â€ðŸ¦½å˜£ï¼ï¼ï¼ðŸ’¥ðŸ’¥ðŸ’¥ðŸ˜„
// ðŸ‘‹è¯•æŽ¢å°±åˆ°æ­¤ä¸ºæ­¢äº†â„ï¸ä¸‡å‰‘âš”å¤©æ¥~ðŸ—¡â„ï¸ðŸ—¡â„ï¸ðŸ—¡~
// å®¢äººå²‚èƒ½ä¸æ‹›å¾…ðŸ¦Šå’±ä»¬è¿˜æ˜¯ä»¥å’Œä¸ºè´µðŸ’¥å—¯ï½žé¢å‘µå‘µï½žðŸ””
// ðŸƒðŸƒðŸƒæ²¡è§è¿‡è¿™ä¹ˆå¤§çš„é’»çŸ³ðŸ’Žå§ï¼ŸðŸ”„ðŸ”¨ðŸ’Žé€ç»™ä½ ï¼ðŸ’ŽðŸ’¥ðŸ‘ª
// æ‹œæ‰˜è®©æˆ‘æ‘¸ä¸ªðŸŸå§ï¼ŒðŸ˜£ðŸ¤šðŸ€„ðŸ¤©ðŸ¤šðŸ€„è¿™ä¸å°±ç³Šäº†ðŸ”ª
// ðŸ¤ºðŸ˜ ðŸ¢ç”Ÿæ­»è™šå®žï¼Œä¸€å¿µä¹‹é—´ã€‚ðŸ˜‘ðŸ˜ðŸŒ³ðŸƒæ´žå¤©å¹»åŒ–ðŸƒðŸƒé•¿æ¢¦ä¸€è§‰ï¼ðŸ‘¿ç ´ï¼ðŸƒðŸƒðŸ˜¡ðŸ¢
// è§è¯†ä¸€ä¸‹æ˜Ÿè¾°ç²‰ç¢Žçš„æ ·å­å§ï¼ðŸ¦¯ðŸŒ‘ç”Ÿå­˜è¿˜æ˜¯æ¯ç­ âœ‚ðŸŒ—ä½ åˆ«æ— é€‰æ‹©ðŸ¤“ðŸ¤”
// ðŸ˜ æˆ‘ä»¥æœ—é“ä¹‹åï¼ŒåŽ†ç»é£Žé›ªâœŠï¼Œç­‘æˆæ­¤å¿—ðŸ”ï¸ï¼Œæ°¸ä¸ç»ˆç»“ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§
// æˆ‘æƒ³ðŸ’ºä½ å¯èƒ½è¿˜ä¸æ˜Žç™½ðŸ¦µäººç±»ä»Žä¸æŽ©é¥°æŽŒæŽ§æ˜Ÿç©ºçš„æ¬²æœ›ðŸŽ†å½“ç„¶ï¼Œä¹ŸåŒ…æ‹¬æˆ‘åœ¨å†…â˜•ðŸ‘ŒðŸ»ðŸ‘©ðŸ»
// éšè´è¶ðŸ¦‹ä¸€èµ·æ¶ˆæ•£å§ðŸ˜ ï¼Œæ—§ä¸–çš„å¹»å½±ðŸ‘¾
// ç¦»å¼€å…‹æ‹‰æ‹‰ðŸ¤–ðŸ–ðŸ¿å¸®å¸®æˆ‘ï¼å²ç“¦ç½—å…ˆç”ŸðŸ˜­
// æˆ‘ä»¥æœ—é“ä¹‹åðŸ˜ ï¼Œå†°é›ªé“¸æˆæ­¤å¿—ðŸ›¡ï¸ðŸ›¡ï¸ï¼Œæ°¸ä¸ç»ˆç»“â„ï¸â„ï¸â„ï¸ï¼
// è¿™ä¹ˆå¤§çš„é’»çŸ³ðŸ’Žï¼Œé€ç»™ä½ ï¼
// ðŸŒŠå°±è®©ä½ çœ‹çœ‹ï¼Œè¿™è‘«èŠ¦é‡Œå–çš„æ˜¯ä»€ä¹ˆè¯ðŸŒŠâ›„ðŸ’¦
// ç”Ÿå­˜è¿˜æ˜¯æ¯ç­ï¼Œä½ åˆ«æ— é€‰æ‹©ðŸ‘¨ðŸ»ðŸ‘“ðŸ–•ðŸ»ï¼ðŸŽ†
// è§„åˆ™ðŸ˜ å°±æ˜¯ç”¨æ¥æ‰“ç ´çš„ðŸâœŠðŸ˜ 
// -----------------------------------------------------------------------------------------

import { computed } from 'vue'
import { storeToRefs } from 'pinia'
import {
  NButton,
  NCard,
  NInput,
  NInputNumber,
  NPopover,
  NSelect,
  NSpace,
  NSwitch,
  SelectOption
} from 'naive-ui'
import { useI18n } from 'vue-i18n'

import ioPath from '../utils/IOPath'
import {
  CPUmodelOptions,
  GetModelNoiseOptionsByNameAndScale,
  modelOptions,
  modelScaleOptions
} from '../utils/ModelOptions'
import { useIOPathStore } from '../store/ioPathStore'
import { useGlobalSettingsStore } from '../store/globalSettingsStore'
import { useSRSettingsStore } from '../store/SRSettingsStore'

const { SRgpuid, deviceList } = storeToRefs(useGlobalSettingsStore())
const { selectedModel, selectedScale, selectedNoise, useTTA, CustomScaleValue } = storeToRefs(
  useSRSettingsStore()
)
const { outputpath } = storeToRefs(useIOPathStore())
const { t } = useI18n()

class MyPopoverMessages {
  static Device(): string {
    return t('Final2xSettings.text0')
  }

  static Model(): string {
    if (selectedModel.value == 'RealCUGAN-pro' || selectedModel.value == 'RealCUGAN-se') {
      return t('Final2xSettings.text1')
    } else if (
      selectedModel.value == 'RealESRGAN-animevideov3' ||
      selectedModel.value == 'RealESRGAN' ||
      selectedModel.value == 'RealESRGAN-anime'
    ) {
      return t('Final2xSettings.text2')
    } else if (
      selectedModel.value == 'Waifu2x-cunet' ||
      selectedModel.value == 'Waifu2x-upconv_7_anime_style_art_rgb' ||
      selectedModel.value == 'Waifu2x-upconv_7_photo'
    ) {
      return t('Final2xSettings.text3')
    } else if (selectedModel.value == 'SRMD') {
      return t('Final2xSettings.text4')
    }
  }

  static ModelScale(): string {
    return t('Final2xSettings.text5')
  }

  static ModelDenoise(): string {
    return t('Final2xSettings.text6')
  }

  static TTA(): string {
    return t('Final2xSettings.text7')
  }

  static CustomScale(): string {
    return t('Final2xSettings.text8')
  }

  static OutputFolder(): string {
    return t('Final2xSettings.text9')
  }
}

function getPath(): void {
  // eslint-disable-next-line @typescript-eslint/ban-ts-comment
  // @ts-ignore
  window.electron.ipcRenderer.send('open-directory-dialog', 'openDirectory')
  // eslint-disable-next-line @typescript-eslint/ban-ts-comment
  // @ts-ignore
  window.electron.ipcRenderer.on('selectedItem', function (e, path) {
    console.log(ioPath.getoutputpath())
    ioPath.setoutputpathManual(path)
  })
}

// -----------------------------------------------------------------------------------------
// Cascade selection, the order is: gpuid -> model -> scale -> noise
// -----------------------------------------------------------------------------------------

const getEnabledModelOptions = computed(() => {
  console.log('getEnabledModelOptions' + SRgpuid.value)
  // RealESRGAN-animevideov3ã€RealESRGANã€RealESRGAN-anime and SRMD are not supported on CPU
  return SRgpuid.value === -1 ? CPUmodelOptions : modelOptions
})

// eslint-disable-next-line @typescript-eslint/no-unused-vars
function ModelOptionsFallBack(value: string): SelectOption {
  selectedModel.value = 'RealCUGAN-pro'
  console.log('modelOptionsFallBack' + selectedModel.value)
  return {
    label: 'RealCUGAN-pro',
    value: 'RealCUGAN-pro'
  }
}

const getScaleOptions = computed(() => {
  console.log('getScaleOptions' + selectedModel.value)
  return modelScaleOptions[selectedModel.value]
})

// eslint-disable-next-line @typescript-eslint/no-unused-vars
function ScaleOptionsFallBack(value: number): SelectOption {
  const defaultScales: { [key: string]: number } = {
    'RealCUGAN-se': 2,
    'RealCUGAN-pro': 2,
    'RealESRGAN-animevideov3': 2,
    RealESRGAN: 4,
    'RealESRGAN-anime': 4,
    'Waifu2x-cunet': 2,
    'Waifu2x-upconv_7_anime_style_art_rgb': 2,
    'Waifu2x-upconv_7_photo': 2,
    SRMD: 2
  }
  selectedScale.value = defaultScales[selectedModel.value]
  console.log('ScaleOptionsFallBack' + defaultScales[selectedModel.value])
  return {
    label: defaultScales[selectedModel.value].toString(),
    value: defaultScales[selectedModel.value]
  }
}

const getNoiseOptions = computed(() => {
  console.log(
    'getNoiseOptions' +
      GetModelNoiseOptionsByNameAndScale(selectedModel.value, selectedScale.value).toString()
  )
  return GetModelNoiseOptionsByNameAndScale(selectedModel.value, selectedScale.value)
})

// eslint-disable-next-line @typescript-eslint/no-unused-vars
function NoiseOptionsFallBack(value: number): SelectOption {
  console.log('NoiseOptionsFallBack')
  selectedNoise.value = 0
  return {
    label: '0',
    value: 0
  }
}

class ClickButtomToConsoleLog {
  static selectedModel(): void {
    console.log(selectedModel.value)
  }

  static selectedScale(): void {
    console.log(selectedScale.value)
  }

  static selectedNoise(): void {
    console.log(selectedNoise.value)
  }

  static useTTA(): void {
    console.log(useTTA.value)
  }

  static SRgpuid(): void {
    console.log(SRgpuid.value)
  }

  static CustomScale(): void {
    console.log(CustomScaleValue.value)
  }
}
</script>

<template>
  <n-card :bordered="false" class="settings-card">
    <n-space class="vertical" vertical justify="center">
      <n-space>
        <n-popover trigger="hover" width="400">
          <template #trigger>
            <n-button dashed type="success" @click="ClickButtomToConsoleLog.SRgpuid()">
              Device
            </n-button>
          </template>
          <span> {{ MyPopoverMessages.Device() }} </span>
        </n-popover>

        <n-select v-model:value="SRgpuid" :options="deviceList" style="width: 465px" />
      </n-space>
      <n-space>
        <n-popover trigger="hover" width="400">
          <template #trigger>
            <n-button dashed type="success" @click="ClickButtomToConsoleLog.selectedModel()">
              Model
            </n-button>
          </template>
          <span> {{ MyPopoverMessages.Model() }} </span>
        </n-popover>
        <n-select
          v-model:value="selectedModel"
          :fallback-option="ModelOptionsFallBack"
          :options="getEnabledModelOptions"
          style="width: 250px"
        />
        <n-popover trigger="hover">
          <template #trigger>
            <n-button dashed type="success" @click="ClickButtomToConsoleLog.selectedScale()">
              Model Scale
            </n-button>
          </template>
          <span> {{ MyPopoverMessages.ModelScale() }} </span>
        </n-popover>
        <n-select
          v-model:value="selectedScale"
          :fallback-option="ScaleOptionsFallBack"
          :options="getScaleOptions"
          style="width: 88px"
        />
      </n-space>
      <n-space>
        <n-popover trigger="hover" width="400">
          <template #trigger>
            <n-button dashed type="success" @click="ClickButtomToConsoleLog.selectedNoise()">
              Denoise
            </n-button>
          </template>
          <span> {{ MyPopoverMessages.ModelDenoise() }} </span>
        </n-popover>

        <n-select
          v-model:value="selectedNoise"
          :fallback-option="NoiseOptionsFallBack"
          :options="getNoiseOptions"
          style="width: 80px"
        />

        <n-popover trigger="hover" width="400">
          <template #trigger>
            <n-button dashed type="success" @click="ClickButtomToConsoleLog.useTTA()">
              TTA
            </n-button>
          </template>
          <span> {{ MyPopoverMessages.TTA() }} </span>
        </n-popover>

        <n-switch v-model:value="useTTA" size="large" style="height: 35px"></n-switch>

        <n-popover trigger="hover" width="400">
          <template #trigger>
            <n-button dashed type="success" @click="ClickButtomToConsoleLog.CustomScale()">
              Custom Scale
            </n-button>
          </template>
          <span> {{ MyPopoverMessages.CustomScale() }} </span>
        </n-popover>

        <n-input-number
          v-model:value="CustomScaleValue"
          :max="99999999"
          :min="0"
          :step="0.2"
          style="width: 110px"
        />
      </n-space>

      <n-space>
        <n-popover trigger="hover">
          <template #trigger>
            <n-button round type="success" @click="getPath"> Output Folder</n-button>
          </template>
          <span> {{ MyPopoverMessages.OutputFolder() }} </span>
        </n-popover>

        <n-input v-model:value="outputpath" :placeholder="outputpath" round style="width: 411px" />
      </n-space>
    </n-space>
  </n-card>
</template>

<style lang="scss" scoped>
.settings-card {
  width: fit-content;
  margin: 0 auto;
  height: 100%;
  // transparent
  background-color: rgba(255, 255, 255, 0);

  .vertical {
    height: 100%;
    > div {
      margin-bottom: 20px;
    }
  }
}
</style>
